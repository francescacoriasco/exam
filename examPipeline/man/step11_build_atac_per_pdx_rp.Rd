% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/step11_build_atac_per_pdx_rp.R
\name{step11_build_atac_per_pdx_rp}
\alias{step11_build_atac_per_pdx_rp}
\title{Step 11 â€” Create one ATAC object per PDX from fragments restricted to RP loci}
\usage{
step11_build_atac_per_pdx_rp(
  data_dir,
  barcodes_tsv,
  rp_loci_rds,
  out_dir,
  required_cells = 500L,
  strict = TRUE,
  barcode_parser = function(x) {
     raw_bc <- sub(".*_", "", x)
     m <-
    regexpr("PDX_([^_]+)", x)
     pdx_id <- if (m[1] == -1) 
         NA_character_
    
    else sub("^PDX_", "", regmatches(x, m))
     list(pdx = pdx_id, bc = raw_bc)
 },
  fragments_finder = function(pdx_id, data_dir) {
     patt_bgz <- paste0("_PDX_",
    pdx_id, "_atac_fragments\\\\.tsv\\\\.bgz$")
     patt_gz <- paste0("_PDX_", pdx_id,
    "_atac_fragments\\\\.tsv\\\\.gz$")
     hit_bgz <- list.files(data_dir, pattern =
    patt_bgz, full.names = TRUE, recursive = TRUE)
     if (length(hit_bgz)) 
        
    return(hit_bgz[1])
     hit_gz <- list.files(data_dir, pattern = patt_gz, full.names
    = TRUE, recursive = TRUE)
     if (length(hit_gz)) 
         return(hit_gz[1])
    
    NA_character_
 },
  ensure_bgzf = TRUE,
  chunk = 200000L,
  verbose = TRUE
)
}
\arguments{
\item{data_dir}{Directory containing fragments files (searched recursively by \code{fragments_finder}).}

\item{barcodes_tsv}{Path to Step 5 \code{barcodes.tsv} (merged scRNA barcodes).}

\item{rp_loci_rds}{Path to Step 10 RP loci RDS (GRanges).}

\item{out_dir}{Output directory for per-PDX ATAC objects.}

\item{required_cells}{Cells required per PDX (default 500).}

\item{strict}{If TRUE, stops if not exactly \code{required_cells} are present in fragments.}

\item{barcode_parser}{Function mapping a merged barcode -> list(pdx=..., bc=...).}

\item{fragments_finder}{Function(pdx_id, data_dir) -> fragments path (.bgz or .gz).}

\item{ensure_bgzf}{If TRUE, converts \code{.gz} -> \code{.bgz} using bgzip.}

\item{chunk}{Chunk size when scanning fragments for existing barcodes.}

\item{verbose}{If TRUE, prints progress.}
}
\value{
Invisible list with \code{created}, \code{paths}, \code{out_dir}.
}
\description{
For each PDX, selects the same \code{required_cells} cells used in Step 5 (from \code{barcodes.tsv}),
finds the corresponding ATAC fragments file, ensures BGZF + tabix index, harmonizes contig naming,
computes a FeatureMatrix on RP loci, and saves one Seurat ATAC object per PDX as RDS.
}
